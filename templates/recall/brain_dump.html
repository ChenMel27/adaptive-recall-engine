{% extends "recall/base.html" %}
{% block title %}Brain Dump â€“ {{ attempt.topic.name }}{% endblock %}

{% block content %}
<div class="session-header">
    <div class="session-info">
        <h1>ğŸ§  Brain Dump</h1>
        <p class="topic-badge">[{{ attempt.topic.standard }}] {{ attempt.topic.name }}</p>
        <p class="session-meta">Hey {{ attempt.student_name }}! &bull; Round {{ attempt.turn_count|add:1 }} of {{ attempt.max_turns }} &bull; <span class="streak-indicator">ğŸ”¥ Keep going!</span></p>
    </div>
    <div class="session-progress">
        <div class="progress-bar">
            <div class="progress-fill" style="width: {% widthratio attempt.turn_count attempt.max_turns 100 %}%"></div>
        </div>
        <form method="post" action="{% url 'recall:opt_out' attempt_id=attempt.pk %}" class="opt-out-form">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline btn-sm">I'm Done ğŸ‘‹</button>
        </form>
    </div>
</div>

{% if last_feedback %}
<div class="feedback-card">
    <h3>ğŸ’¬ Here's what I noticed...</h3>

    {% if last_feedback.overall_feedback %}
    <p class="feedback-text">{{ last_feedback.overall_feedback }}</p>
    {% endif %}

    {% if last_feedback.misconceptions %}
    <div class="feedback-section misconceptions">
        <h4>ğŸ” Let's Clear This Up</h4>
        {% for m in last_feedback.misconceptions %}
        <div class="misconception-item">
            <p class="misconception-claim">You wrote: "{{ m.claim }}"</p>
            <p class="misconception-correction">ğŸ’¡ {{ m.correction }}</p>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if attempt.demonstrated_concepts %}
    <div class="feedback-section correct">
        <h4>ğŸ¯ Concepts You Nailed</h4>
        <div class="concept-tags">
            {% for concept in attempt.demonstrated_concepts %}
            <span class="tag tag-success">âœ“ {{ concept }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if attempt.missing_concepts %}
    <div class="feedback-section missing">
        <h4>ğŸ“Œ Still to Explore</h4>
        <div class="concept-tags">
            {% for concept in attempt.missing_concepts %}
            <span class="tag tag-warning">{{ concept }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="interaction-card">
    {% if is_first_turn %}
    <h2>Tell me everything you know about: <em>{{ attempt.topic.name }}</em></h2>
    <p class="prompt-hint">ğŸ’­ Don't stress about being perfect â€” just dump everything that comes to mind! This is NOT graded.</p>
    {% else %}
    <h2>ğŸ¤” Follow-Up Question</h2>
    <div class="follow-up-prompt">
        <p>{{ follow_up_question }}</p>
    </div>
    {% endif %}

    <form method="post" action="{% url 'recall:brain_dump_submit' attempt_id=attempt.pk %}" id="brain-dump-form">
        {% csrf_token %}
        <textarea name="response" class="form-textarea" rows="{% if is_first_turn %}8{% else %}5{% endif %}"
                  placeholder="{% if is_first_turn %}Start typing what you remember... ğŸ’­{% else %}Type your answer here... ğŸ’¡{% endif %}"
                  required autofocus></textarea>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submit-btn">Send It! ğŸš€</button>
        </div>
    </form>

    <div class="thinking-overlay" id="thinking-overlay">
        <div class="thinking-bubble">
            <div class="thinking-dots">
                <span></span><span></span><span></span>
            </div>
            <span class="thinking-text">ğŸ§¬ BioRecall is analyzing your answer...</span>
        </div>
    </div>
</div>

{% if turns %}
<details class="conversation-history">
    <summary>ğŸ“œ Your Conversation So Far ({{ turns.count }} rounds)</summary>
    <div class="history-list">
        {% for turn in turns %}
        <div class="history-item">
            <div class="history-prompt"><strong>Round {{ turn.turn_number }}:</strong> {{ turn.prompt }}</div>
            <div class="history-response">{{ turn.student_response }}</div>
            {% if turn.is_correct is not None %}
            <span class="tag {% if turn.is_correct %}tag-success{% else %}tag-warning{% endif %}">
                {% if turn.is_correct %}ğŸ¯ Nailed It{% else %}ğŸ”„ Keep Exploring{% endif %}
            </span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</details>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('brain-dump-form').addEventListener('submit', function() {
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-btn').textContent = 'Analyzing... ğŸ§¬';
    document.getElementById('thinking-overlay').classList.add('active');
});
</script>
{% endblock %}